import{r as l,u as T,j as e,E as B,c as A,b as D,a as I,d as U,L as R}from"./index-Ce-aIIIL.js";import{A as P,c as v,B as E}from"./Badge-MNIyWpy1.js";import{f as F,b as V,a as z,c as M}from"./index-CABy_kWu.js";const H=4,Y=l.memo(function a({post:t,onReply:b,depth:m=0,threadId:g}){const{getUser:h,votePost:j}=T(),[u,N]=l.useState(!1),i=h(t.authorId),n=t.authorId==="currentUser",c=t.children&&t.children.length>0,x=l.useCallback(s=>{j(t.id,s)},[t.id,j]),o=()=>N(s=>!s);return e.jsxs("div",{className:v("relative flex gap-0",m>0&&"ml-4 sm:ml-6"),id:`post-${t.id}`,"aria-label":`Reply by ${i==null?void 0:i.name}`,children:[c&&e.jsx("div",{className:"relative flex flex-col items-center mr-3 flex-shrink-0",children:e.jsx("button",{onClick:o,className:"thread-line relative w-0.5 mt-10 mb-0","aria-label":u?"Expand replies":"Collapse replies",title:u?"Expand":"Collapse",style:{height:"calc(100% - 2.5rem)"}})}),!c&&m>0&&e.jsx("div",{className:"w-0.5 mr-3 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:v("card p-4 mb-3 transition-all duration-200",!t.isRead&&"border-l-2 border-l-rust-300",n&&"bg-parchment-50 dark:bg-ink-750"),children:[e.jsxs("div",{className:"flex items-start gap-3 mb-3",children:[e.jsx(P,{user:i,size:"sm"}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{children:e.jsxs("span",{className:"font-semibold text-sm text-ink-900 dark:text-parchment-100",children:[i==null?void 0:i.name,n&&e.jsx("span",{className:"ml-1 text-xs text-rust-500 font-normal",children:"(you)"})]})}),e.jsx("time",{className:"text-xs text-ink-400 dark:text-ink-500 flex-shrink-0",dateTime:t.createdAt,title:new Date(t.createdAt).toLocaleString(),children:F(t.createdAt)})]})})]}),e.jsx("div",{className:"text-sm text-ink-700 dark:text-parchment-200 leading-relaxed whitespace-pre-wrap break-words mb-3",children:t.body}),e.jsxs("div",{className:"flex items-center gap-1 -ml-1",role:"group","aria-label":"Post actions",children:[e.jsx("button",{onClick:()=>x(1),className:v("btn-ghost text-xs",t.userVote===1&&"text-rust-500 bg-rust-50 dark:bg-rust-900/20"),"aria-label":`Upvote (${t.votes>0?t.votes:0} votes)`,"aria-pressed":t.userVote===1,children:"‚ñ≤"}),e.jsx("span",{className:v("text-xs font-mono font-medium px-1",t.votes>0?"text-rust-600 dark:text-rust-400":t.votes<0?"text-ink-400":"text-ink-500"),"aria-live":"polite",children:t.votes}),e.jsx("button",{onClick:()=>x(-1),className:v("btn-ghost text-xs",t.userVote===-1&&"text-ink-500 bg-ink-100 dark:bg-ink-700"),"aria-label":"Downvote","aria-pressed":t.userVote===-1,children:"‚ñº"}),m<H&&e.jsx("button",{onClick:()=>b(t.id),className:"btn-ghost text-xs ml-2","aria-label":`Reply to ${i==null?void 0:i.name}`,children:"‚Ü© Reply"}),c&&e.jsx("button",{onClick:o,className:"btn-ghost text-xs ml-auto","aria-label":u?`Expand ${t.children.length} replies`:"Collapse replies","aria-expanded":!u,children:u?`‚ñ∂ ${t.children.length} ${t.children.length===1?"reply":"replies"}`:"‚ñº Collapse"})]})]}),c&&!u&&e.jsx("div",{className:"animate-slide-down",role:"list","aria-label":"Nested replies",children:t.children.map(s=>e.jsx("div",{role:"listitem",children:e.jsx(a,{post:s,onReply:b,depth:m+1,threadId:g})},s.id))}),c&&u&&e.jsxs("button",{onClick:o,className:"text-xs text-ink-400 dark:text-ink-500 hover:text-rust-500 ml-4 mb-3 transition-colors","aria-label":`Expand ${t.children.length} collapsed replies`,children:["[",t.children.length," ",t.children.length===1?"reply":"replies"," hidden ‚Äî click to expand]"]})]})]})});function _({posts:a,onReply:t,threadId:b}){const m=l.useMemo(()=>V(a),[a]);return m.length===0?e.jsx(B,{icon:"üåø",title:"No replies yet",description:"Be the first to share your thoughts on this thread."}):e.jsx("div",{role:"list","aria-label":"Discussion replies",className:"space-y-1",children:m.map(g=>e.jsx("div",{role:"listitem",children:e.jsx(Y,{post:g,onReply:t,depth:0,threadId:b})},g.id))})}function G({error:a,id:t}){return a?e.jsx("p",{id:t,role:"alert",className:"text-xs text-rust-500 mt-1",children:a}):null}function S({threadId:a,parentId:t,onCancel:b,autoFocus:m=!1}){const{submitPost:g,loading:h,getUser:j,currentUserId:u,getUser:N}=T(),i=j(u),[n,c]=l.useState(""),[x,o]=l.useState(""),[s,f]=l.useState(""),d=l.useRef(null);l.useEffect(()=>{m&&d.current&&d.current.focus()},[m]);const p=()=>n.trim()?n.trim().length<10?(o("Reply must be at least 10 characters."),!1):(o(""),!0):(o("Reply cannot be empty."),!1),$=C=>{c(C.target.value),x&&C.target.value.trim().length>=10&&o("")},w=async C=>{if(C.preventDefault(),!!p()){f("");try{await g({threadId:a,parentId:t,body:n}),c("")}catch(L){f(L.message||"Failed to post reply. Please try again.")}}},y=n.length,r=5e3,k=y>r;return e.jsx("form",{onSubmit:w,className:"card p-4 animate-slide-up",noValidate:!0,"aria-label":t?"Reply to comment":"Post a reply",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx(P,{user:i,size:"sm"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:`reply-body-${t||"root"}`,className:"sr-only",children:"Your reply"}),e.jsx("textarea",{id:`reply-body-${t||"root"}`,ref:d,value:n,onChange:$,onBlur:p,placeholder:"Share your thoughts‚Ä¶",rows:4,className:`input-base resize-none ${x?"border-rust-400 ring-rust-400/20 ring-2":""}`,"aria-describedby":x?`reply-error-${t||"root"}`:void 0,"aria-invalid":!!x,disabled:h.submitting,maxLength:r+100}),e.jsxs("div",{className:"flex justify-between items-center mt-1",children:[e.jsx(G,{error:x,id:`reply-error-${t||"root"}`}),e.jsxs("span",{className:`text-xs ml-auto ${k?"text-rust-500 font-medium":"text-ink-400"}`,"aria-live":"polite","aria-label":`${y} of ${r} characters used`,children:[y,"/",r]})]})]}),s&&e.jsx("p",{role:"alert",className:"text-xs text-rust-500 mt-2",children:s}),e.jsxs("div",{className:"flex items-center gap-2 mt-3",children:[e.jsx("button",{type:"submit",className:"btn-primary",disabled:h.submitting||k||!n.trim(),"aria-busy":h.submitting,children:h.submitting?e.jsxs(e.Fragment,{children:[e.jsx(A,{size:"sm",label:"Posting‚Ä¶"}),"Posting‚Ä¶"]}):"Post Reply"}),b&&e.jsx("button",{type:"button",onClick:b,className:"btn-ghost",disabled:h.submitting,children:"Cancel"})]})]})]})})}function q(){var y;const{threadId:a}=D(),t=I(),{getThread:b,getUser:m,getCategory:g,getPostsByThread:h,markThreadRead:j,loading:u}=T(),[N,i]=l.useState(!0),[n,c]=l.useState(null),[x,o]=l.useState(!1);l.useEffect(()=>{const r=setTimeout(()=>{i(!1),j(a)},600);return()=>clearTimeout(r)},[a,j]);const s=b(a),f=m(s==null?void 0:s.authorId),d=g(s==null?void 0:s.categoryId),p=l.useMemo(()=>h(a),[a,h]),$=l.useCallback(r=>{c(r),o(!1),setTimeout(()=>{var k;(k=document.getElementById(`reply-form-${r}`))==null||k.scrollIntoView({behavior:"smooth",block:"center"})},100)},[]),w=()=>{o(!0),c(null),setTimeout(()=>{var r;(r=document.getElementById("root-reply-form"))==null||r.scrollIntoView({behavior:"smooth",block:"center"})},100)};return l.useCallback(()=>{c(null),o(!1)},[]),N?e.jsx(U,{message:"Loading discussion‚Ä¶"}):s?e.jsxs("main",{id:"main-content",className:"max-w-4xl mx-auto px-4 py-8",children:[e.jsx("nav",{"aria-label":"Breadcrumb",className:"mb-6",children:e.jsxs("ol",{className:"flex items-center gap-2 text-sm flex-wrap",children:[e.jsx("li",{children:e.jsx(R,{to:"/",className:"text-ink-400 hover:text-rust-500 transition-colors",children:"Discussions"})}),d&&e.jsxs(e.Fragment,{children:[e.jsx("li",{className:"text-ink-300 dark:text-ink-600","aria-hidden":"true",children:"/"}),e.jsx("li",{children:e.jsxs(R,{to:`/category/${d.id}`,className:"text-ink-400 hover:text-rust-500 transition-colors",children:[d.icon," ",d.name]})})]}),e.jsx("li",{className:"text-ink-300 dark:text-ink-600","aria-hidden":"true",children:"/"}),e.jsx("li",{className:"text-ink-600 dark:text-parchment-300 truncate max-w-xs","aria-current":"page",title:s.title,children:s.title})]})}),e.jsxs("article",{"aria-labelledby":"thread-title",children:[e.jsxs("header",{className:"mb-8",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3 flex-wrap",children:[s.isPinned&&e.jsx(E,{variant:"pinned",children:"üìå Pinned"}),d&&e.jsxs(R,{to:`/category/${d.id}`,className:`badge ${d.color} hover:opacity-80 transition-opacity`,children:[d.icon," ",d.name]})]}),e.jsx("h1",{id:"thread-title",className:"font-display text-2xl sm:text-3xl font-semibold text-ink-900 dark:text-parchment-100 mb-4 text-balance",children:s.title}),e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx(P,{user:f,size:"md"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm text-ink-800 dark:text-parchment-200",children:f==null?void 0:f.name}),e.jsxs("p",{className:"text-xs text-ink-400 dark:text-ink-500",children:[e.jsx("time",{dateTime:s.createdAt,title:new Date(s.createdAt).toLocaleString(),children:z(s.createdAt)})," ¬∑ ",M(s.views)," views"," ¬∑ ",p.length," ",p.length===1?"reply":"replies"]})]})]}),((y=s.tags)==null?void 0:y.length)>0&&e.jsx("div",{className:"flex gap-1.5 flex-wrap","aria-label":"Thread tags",children:s.tags.map(r=>e.jsxs(E,{variant:"tag",children:["#",r]},r))})]}),e.jsxs("div",{className:"card p-6 mb-8",children:[e.jsx("div",{className:"prose-like text-ink-700 dark:text-parchment-200 leading-relaxed whitespace-pre-wrap break-words font-body",children:s.body}),e.jsxs("div",{className:"flex items-center gap-3 mt-6 pt-4 border-t border-parchment-200 dark:border-ink-700",children:[e.jsx("button",{onClick:w,className:"btn-primary","aria-label":"Write a reply to this thread",children:"‚Ü© Reply"}),e.jsx("button",{onClick:()=>t(-1),className:"btn-ghost","aria-label":"Go back",children:"‚Üê Back"})]})]})]}),e.jsxs("section",{"aria-labelledby":"replies-heading",children:[e.jsx("h2",{id:"replies-heading",className:"font-display text-xl font-semibold text-ink-800 dark:text-parchment-100 mb-6",children:p.length>0?`${p.length} ${p.length===1?"Reply":"Replies"}`:"Discussion"}),x&&e.jsx("div",{id:"root-reply-form",className:"mb-6",children:e.jsx(S,{threadId:a,parentId:null,onCancel:()=>o(!1),autoFocus:!0})}),e.jsx(_,{posts:p,threadId:a,onReply:r=>$(r)}),n&&e.jsxs("div",{id:`reply-form-${n}`,className:"mt-6 ml-10",children:[e.jsxs("p",{className:"text-xs text-ink-400 mb-2",children:["Replying to a comment‚Ä¶"," ",e.jsx("button",{onClick:()=>c(null),className:"text-rust-500 hover:text-rust-600 underline",children:"Cancel"})]}),e.jsx(S,{threadId:a,parentId:n,onCancel:()=>c(null),autoFocus:!0})]}),!x&&!n&&e.jsx("div",{className:"mt-8 pt-6 border-t border-parchment-200 dark:border-ink-700",children:e.jsx("button",{onClick:w,className:"btn-secondary",children:"‚Ü© Add a Reply"})})]})]}):e.jsx("main",{id:"main-content",className:"max-w-4xl mx-auto px-4 py-16",children:e.jsx(B,{icon:"üîç",title:"Thread not found",description:"This thread may have been removed.",action:e.jsx(R,{to:"/",className:"btn-primary",children:"Back to Home"})})})}export{q as default};
